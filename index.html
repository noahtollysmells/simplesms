<!DOCTYPE html>
<html>
<head>
    <title>Fixed Ably Chat</title>
    <script src="https://cdn.ably.com"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; }
        #chat-container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #status { font-size: 12px; color: #666; margin-bottom: 10px; }
        #messages { height: 300px; border: 1px solid #ddd; overflow-y: auto; padding: 10px; margin-bottom: 10px; background: #fafafa; }
        .msg { margin-bottom: 8px; padding: 5px; border-bottom: 1px solid #eee; }
        .input-area { display: flex; gap: 5px; }
        input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>

<div id="chat-container">
    <h3>Network Chat</h3>
    <div id="status">Connecting to Ably...</div>
    <div id="messages"></div>
    
    <div class="input-area">
        <input type="text" id="userInput" placeholder="Name" style="width: 20%;">
        <input type="text" id="textInput" placeholder="Type a message..." disabled>
        <button id="sendBtn" onclick="send()" disabled>Send</button>
    </div>
</div>

<script>
    const statusDiv = document.getElementById('status');
    const sendBtn = document.getElementById('sendBtn');
    const textInput = document.getElementById('textInput');
    const messagesDiv = document.getElementById('messages');

    // 1. Connect with your API Key
    const ably = new Ably.Realtime('mQBTog.DO3Uhw:eIeE_76e_a-KhqAn1L1DC-bTTXo1na0eTylY3tY2NVE');
    const channel = ably.channels.get('chat-room');

    // 2. Monitor Connection Status
    ably.connection.on('connected', () => {
        statusDiv.innerText = "â— Connected and ready";
        statusDiv.style.color = "green";
        sendBtn.disabled = false;
        textInput.disabled = false;
    });

    ably.connection.on('failed', () => {
        statusDiv.innerText = "X Connection failed. Check your API key.";
        statusDiv.style.color = "red";
    });

    // 3. Listen for Messages
    channel.subscribe('msg', (message) => {
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `<b>${message.data.user}:</b> ${message.data.text}`;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // 4. Send Function
    function send() {
        const user = document.getElementById('userInput').value || "Guest";
        const text = textInput.value;

        if (text.trim() !== "") {
            channel.publish('msg', { user: user, text: text }, (err) => {
                if (err) {
                    console.error("Publish failed:", err);
                    alert("Error sending message: " + err.message);
                } else {
                    textInput.value = ''; // Clear box only if it actually sent
                }
            });
        }
    }

    // Allow Enter key
    textInput.addEventListener("keypress", (e) => { if (e.key === "Enter") send(); });
</script>

</body>
</html>
